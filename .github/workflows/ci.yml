name: CI

on: [push]

jobs:
  build_and_test_linux:
    strategy:
     matrix:
        platform: [ubuntu-20.04]
    runs-on: ${{ matrix.platform }}
    env:
      MG_VERSION: "1.6.0"
      POSTGRES_VERSION: "13.3"
    steps:
      - name: Set-up repository
        uses: actions/checkout@v2
      - name: Install environment
        run: |
          sudo apt install -y gcc g++ python3
          pip3 install pymgclient psycopg2
      - name: Pull Memgraph Docker image
        run: |
          docker pull memgraph/memgraph:${{ env.MG_VERSION }}-community
      - name: Build mgmigrate 
        run: |
          mkdir build && cd build
          cmake -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -DCMAKE_BUILD_TYPE=Release ..
          make -j8
      - name: Test PostgreSQL
        run: |
          docker run -d -p 7687:7687 memgraph/memgraph:${{ env.MG_VERSION }}-community --telemetry-enabled=false

          # Pull and run postgres docker image
          docker pull postgres:${{ env.POSTGRES_VERSION }}
          docker run --name postgres-test -e POSTGRES_PASSWORD=postgres -p 5432:5432 -d postgres:${{ env.POSTGRES_VERSION }}

          cd tests/e2e
          ./postgresql.py

          docker stop $(docker ps -a -q)
          
